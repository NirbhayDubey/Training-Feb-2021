--------------------------DEPOSIT--------------------------
CREATE TABLE DEPOSIT
(
	ACTNO VARCHAR(5) PRIMARY KEY NOT NULL,
	CNAME VARCHAR(19) NOT NULL,
	BNAME VARCHAR(18) NOT NULL,
	AMOUNT INT NOT NULL,
	ADATE DATE
)
GO

INSERT INTO DEPOSIT VALUES
('100','ANIL','VRCE',1000,'1-MAR-1995'),
('101','SUNIL','AJNI',5000,'4-JAN-1996'),
('102','MEHUL','KAROLBAGH',3500,'17-NOV-1995'),
('104','MADHURI','CHANDNI',1200,'17-DEC-1995'),
('105','PRAMOD','M.G.ROAD',3000,'27-MAR-1996'),
('106','SANDIP','ANDHERI',2000,'31-MAR-1996'),
('107','SHIVANI','VIRAR',1000,'5-SEP-1995'),
('108','KRANTI','NEHRU PLACE',5000,'2-JUL-1995'),
('109','NAREN','POWAI',7000,'10-AUG-1995')
GO

--------------------------BRANCH--------------------------


CREATE TABLE BRANCH
(
	BNAME VARCHAR(18) PRIMARY KEY NOT NULL,
	CITY VARCHAR(18) NOT NULL
)
GO

INSERT INTO BRANCH VALUES
('VRCE','NAGPUR'),
('AJNI','NAGPUR'),
('KAROLBAGH','DELHI'),
('CHANDNI','DELHI'),
('DHARAMPETH','NAGPUR'),
('M.G.ROAD','BANGLORE'),
('ANDHERI','MUMBAI'),
('VIRAR','MUMBAI'),
('NEHRU PLACE','DELHI'),
('POWAI','MUMBAI')
GO

--------------------------CUSTOMER--------------------------

CREATE TABLE CUSTOMER
(
	CNAME VARCHAR(19) PRIMARY KEY,
	CITY VARCHAR(18)
)

INSERT INTO CUSTOMER VALUES
('ANIL','KOLKATA'),
('SUNIL','DELHI'),
('MEHUL','BARODA'),
('MANDHAR','PATNA'),
('MADHURI','NAGPUR'),
('PRAMOD','NAGPUR'),
('SANDIP','SURAT'),
('SHIVANI','MUMBAI'),
('KRANTI','MUMBAI'),
('NAREN','MUMBAI')
GO

--------------------------BORROW--------------------------


CREATE TABLE BORROW
(
	LOANNO VARCHAR(5) PRIMARY KEY NOT NULL,
	CNAME VARCHAR(19) FOREIGN KEY REFERENCES CUSTOMER(CNAME),
	BNAME VARCHAR(18) FOREIGN KEY REFERENCES BRANCH(BNAME),
	AMOUNT INT
)

INSERT INTO BORROW VALUES
('201','ANIL','VRCE',1000),
('206','MEHUL','AJNI',5000),
('311','SUNIL','DHARAMPETH',3000),
('321','MADHURI','ANDHERI',2000),
('375','PRAMOD','VIRAR',8000),
('481','KRANTI','NEHRU PLACE',3000)
GO

ALTER TABLE DEPOSIT
ADD FOREIGN KEY(CNAME) REFERENCES CUSTOMER(CNAME);
GO
ALTER TABLE DEPOSIT
ADD FOREIGN KEY(BNAME) REFERENCES BRANCH(BNAME);
GO

SELECT * FROM DEPOSIT
GO
SELECT * FROM BRANCH
GO
SELECT * FROM CUSTOMER
GO
SELECT * FROM BORROW
GO

/*Q1: Create a Store Procedure which will accept name of the customer as input parameter and product the following output, List Names of 
Customers who are Depositors and have Same Branch City as that of input parameter customer’s Name.*/
CREATE OR ALTER PROCEDURE PROCUSTOMER1 @CNAME VARCHAR(19) 
AS
SELECT D.CNAME,C.CITY FROM DEPOSIT D JOIN CUSTOMER C ON D.CNAME=C.CNAME
WHERE C.CITY =
(SELECT CITY FROM CUSTOMER WHERE CNAME=@CNAME)
GO

EXEC PROCUSTOMER1 @CNAME ='NAREN'
GO


/*Q2: Create a Store Procedure which will accept name of the customer as input parameter and produce the following output List in JSON 
format, All the Depositors Having Depositors Having Deposit in All the Branches where input parameter customer is Having an Account*/
CREATE OR ALTER PROCEDURE PROCUSTOMER2 @CNAME VARCHAR(19), @DATA NVARCHAR(MAX) OUTPUT
AS
SET @DATA = (SELECT CNAME FROM DEPOSIT WHERE BNAME IN 
			(SELECT DISTINCT BNAME FROM DEPOSIT WHERE CNAME=@CNAME)
			GROUP BY CNAME HAVING COUNT(*) = 
			(SELECT COUNT(BNAME) FROM DEPOSIT WHERE  CNAME=@CNAME)
			FOR JSON PATH, ROOT('DEPOSITS'))
			SELECT @DATA
GO

EXEC PROCUSTOMER2 @CNAME= 'SHIVANI' ,@DATA=OUTPUT
GO


/*Q3: Create a Store Procedure that will accept city name and returns the number of customers in that city.*/
CREATE OR ALTER PROCEDURE PROCUSTOMER3 @CITY VARCHAR(19)
AS
SELECT COUNT(CITY) FROM CUSTOMER WHERE CITY=@CITY
GO

EXEC PROCUSTOMER3 @CITY=  'MUMBAI'
GO


/*Q4: Create a Store Procedure which will accept city of the customer as input parameter and product the following output List in JSON 
format List All the Customers Living in city provided in input parameter and Having the Branch City as MUMBAI or DELHI*/
CREATE OR ALTER PROCEDURE PROCUSTOMER4 @CITY VARCHAR(18), @OUTPUT NVARCHAR(MAX) OUTPUT
AS
SET @OUTPUT=(SELECT * FROM (SELECT C.* FROM CUSTOMER C JOIN DEPOSIT D ON C.CNAME=D.CNAME WHERE CITY=@CITY AND D.BNAME IN
			(SELECT BNAME FROM BRANCH WHERE CITY IN ('MUMBAI','DELHI'))) AS X
			FOR JSON PATH)
			SELECT @OUTPUT AS 'OUTPUT'
GO
EXEC PROCUSTOMER4 @CITY='MUMBAI', @OUTPUT=OUTPUT
GO

/*Q5: Count the Number of Customers Living in the City where Branch is Located*/
CREATE PROCEDURE PROCUSTOMER5 @CITY VARCHAR(19) = 'MUMBAI'
AS
SELECT COUNT(C.CITY) FROM CUSTOMER C JOIN BRANCH B ON C.CITY=B.CITY 
GROUP BY C.CITY HAVING C.CITY=B.BNAME
GO

SELECT COUNT(C.CITY) FROM BRANCH B  RIGHT JOIN CUSTOMER C ON B.CITY=C.CITY
WHERE B.BNAME IN ( SELECT BNAME FROM BRANCH GROUP BY BNAME)
GROUP BY C.CITY
GO

--EXEC PROCUSTOMER5
GO

DROP PROCEDURE PROCUSTOMER5
GO
/*Q6: Create a Procedure which will accept input in JSON parameter CustomerName,City, ACTNO,Branch,amount  
And insert these record in the Deposit table. Before inserting some validation should be done like amount should be greater than 10Rs. 
and date should always be current date.*/

CREATE OR ALTER PROCEDURE ex6
	@json nvarchar(MAX)
AS
	SET NOCOUNT ON

	IF (SELECT AMOUNT FROM OPENJSON(@json) WITH (AMOUNT int '$.AMOUNT')) <= 10
	BEGIN
		SELECT 'INVALID AMOUNT' AS Error
		RETURN
	END

	INSERT INTO CUSTOMER(CNAME, CITY)  
		(SELECT CNAME, CITY FROM 
			OPENJSON(@json) WITH (
			CNAME varchar(19) '$.CNAME',
			CITY varchar(18) '$.CITY'))

	INSERT INTO DEPOSIT(ACTNO, CNAME, BNAME, AMOUNT, ADATE)  
		(SELECT ACTNO, CNAME, BNAME, AMOUNT, GETDATE() AS ADATE FROM 
			OPENJSON(@json) WITH (
			AMOUNT int '$.AMOUNT',
			ACTNO varchar(5) '$.ACTNO',
			CNAME varchar(19) '$.CNAME',
			BNAME varchar(18) '$.BNAME'))

	SET NOCOUNT OFF
GO

EXEC ex6 @json = N'{
	"ACTNO":"110",
	"CNAME":"ZEEL",
	"BNAME":"AJNI",
	"CITY":"MUMBAI",
	"AMOUNT":500
	}'
GO

SELECT * FROM Deposit WHERE BNAME IN (SELECT BNAME FROM Branch WHERE CITY IN 
(SELECT B.CITY FROM Deposit D JOIN Branch B ON B.BNAME = D.BNAME WHERE D.CNAME = 'SUNIL'))
